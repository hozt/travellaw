---
import Layout from "../../layouts/Layout.astro";
import BannerTitle from "../../components/BannerTitle.astro";
import ContactForm from "../../components/ContactForm.astro";
import client from "../../lib/apolloClient";
import { GET_FORM, GET_ALL_FORMS } from "../../lib/queries";

export async function getStaticPaths() {
  const data = await client.query({
    query: GET_ALL_FORMS,
  });
  const forms = data.data.forms.nodes;
  return forms.map((form) => ({
    params: { slug: form.slug },
  }));
}

const { slug } = Astro.params;

console.log("slug:", slug);

let page;

try {
  const { data } = await client.query({
    query: GET_FORM,
    variables: { slug },
  });
  page = data?.formBy;
} catch (e) {
  console.error("Error fetching page data:", e);
}

if (!page) {
  //return Astro.redirect('/404');
}

---

<Layout title={page?.title} templateId={page?.databaseId} description={page?.metaDescription}>
  <BannerTitle
    title={page?.title}
    subtitle={page?.subtitle}
    image={page?.bannerImage?.sourceUrl}
    width={page?.bannerImage?.mediaDetails?.width}
    height={page?.bannerImage?.mediaDetails?.height}
  />
  <div class="main-body content">
    <div set:html={page?.content} />
    <ContactForm />
  </div>
</Layout>
