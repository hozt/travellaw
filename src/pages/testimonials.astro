---
import client from '../lib/apolloClient';
import Layout from "../layouts/Layout.astro";
import BannerTitle from "../components/BannerTitle.astro";
import { GET_TESTIMONIALS_AND_TEMPLATE } from "../lib/queries";

let testimonials = [];
let page = null;
let error = null;

try {
  // Fetch data using the Apollo Client
  const { data } = await client.query({
    query: GET_TESTIMONIALS_AND_TEMPLATE,
    fetchPolicy: 'cache-first', // Use cache if available
  });

  testimonials = data.testimonials.edges;
  page = data.templateBy;
} catch (e) {
  console.error('Error fetching data:', e);
  error = e.message;
}

if (!page) {
  Astro.redirect('/404');
}

const title = page?.title || "Testimonials";
---

<Layout title={title} templateId={page?.databaseId} class="testimonials" description={page?.metaDescription}>
  <BannerTitle
    title={title}
    subtitle={page?.subtitle}
    image={page?.bannerImage?.sourceUrl}
    width={page?.bannerImage?.mediaDetails?.width}
    height={page?.bannerImage?.mediaDetails?.height}
  />
  <div class="main-body testimonials-wrapper">
    {testimonials.map(({ node }) => (
      <div key={node.databaseId} class="pt-4 border-b-2 testimonial last:border-none">
        <div class="testimonial-title">{node.title}</div>
        <div class="testimonial-content" set:html={node.content} />
        <p class="testimonial-source">{node.source}</p>
      </div>
    ))}
  </div>
</Layout>